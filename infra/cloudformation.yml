AWSTemplateFormatVersion: "2010-09-09"
Description: Education Reserve - AWS Infrastructure

Parameters:
  DBPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: RDS master password

  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: EC2 SSH key pair name

  MyIP:
    Type: String
    Description: Your IP address for SSH access (e.g. 113.35.0.242/32)
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/32

  GitHubRepo:
    Type: String
    Default: https://github.com/suzuki-tomok/education-reserve.git
    Description: GitHub repository URL

Resources:
  # ============================================
  # VPC
  # ============================================
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: education-reserve-vpc

  # ============================================
  # Subnets
  # ============================================
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: ap-northeast-1a
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: education-reserve-public-1

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: ap-northeast-1c
      Tags:
        - Key: Name
          Value: education-reserve-public-2

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: ap-northeast-1a
      Tags:
        - Key: Name
          Value: education-reserve-private-1

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.4.0/24
      AvailabilityZone: ap-northeast-1c
      Tags:
        - Key: Name
          Value: education-reserve-private-2

  # ============================================
  # Internet Gateway
  # ============================================
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: education-reserve-igw

  IGWAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # ============================================
  # Route Table
  # ============================================
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: education-reserve-public-rt

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: IGWAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  # ============================================
  # Security Groups
  # ============================================
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ALB Security Group
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: education-reserve-alb-sg

  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: EC2 Security Group
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref MyIP
      Tags:
        - Key: Name
          Value: education-reserve-ec2-sg

  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: RDS Security Group
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref EC2SecurityGroup
      Tags:
        - Key: Name
          Value: education-reserve-rds-sg

  # ============================================
  # RDS
  # ============================================
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: education-reserve RDS subnet group
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      Tags:
        - Key: Name
          Value: education-reserve-db-subnet

  RDSInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Delete
    Properties:
      DBInstanceIdentifier: education-reserve-db
      Engine: postgres
      DBInstanceClass: db.t3.micro
      AllocatedStorage: 20
      StorageType: gp2
      MasterUsername: postgres
      MasterUserPassword: !Ref DBPassword
      DBName: education_reserve
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      PubliclyAccessible: false
      BackupRetentionPeriod: 0
      DeleteAutomatedBackups: true
      Tags:
        - Key: Name
          Value: education-reserve-db

  # ============================================
  # EC2
  # ============================================
  EC2Instance:
    Type: AWS::EC2::Instance
    DependsOn: RDSInstance
    Properties:
      InstanceType: t3.micro
      ImageId: !Sub "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}"
      KeyName: !Ref KeyPairName
      SubnetId: !Ref PublicSubnet1
      SecurityGroupIds:
        - !Ref EC2SecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y docker git

          # Docker
          systemctl start docker
          systemctl enable docker
          usermod -aG docker ec2-user

          # Docker Compose
          curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose

          # Docker Buildx
          mkdir -p /usr/local/lib/docker/cli-plugins
          curl -L "https://github.com/docker/buildx/releases/download/v0.21.2/buildx-v0.21.2.linux-amd64" -o /usr/local/lib/docker/cli-plugins/docker-buildx
          chmod +x /usr/local/lib/docker/cli-plugins/docker-buildx

          # App
          cd /home/ec2-user
          git clone ${GitHubRepo} education-reserve
          cd education-reserve

          # .env.docker
          echo "SECRET_KEY=django-insecure-cloudformation-deploy" > .env.docker
          echo "ALLOWED_HOSTS=*" >> .env.docker
          echo "DB_NAME=education_reserve" >> .env.docker
          echo "DB_USER=postgres" >> .env.docker
          echo "DB_PASSWORD=${DBPassword}" >> .env.docker
          echo "DB_HOST=${RDSInstance.Endpoint.Address}" >> .env.docker
          echo "DB_PORT=5432" >> .env.docker

          # Wait for RDS to accept connections
          for i in $(seq 1 30); do
            if docker run --rm postgres:16 pg_isready -h ${RDSInstance.Endpoint.Address} -p 5432 -U postgres; then
              echo "RDS is ready"
              break
            fi
            echo "Waiting for RDS... ($i/30)"
            sleep 10
          done

          # Start app
          /usr/local/bin/docker-compose -f docker-compose.prod.yml up --build -d

          chown -R ec2-user:ec2-user /home/ec2-user/education-reserve
      Tags:
        - Key: Name
          Value: education-reserve-ec2

  # ============================================
  # ALB
  # ============================================
  ALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: education-reserve-alb
      Scheme: internet-facing
      Type: application
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Tags:
        - Key: Name
          Value: education-reserve-alb

  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: education-reserve-tg
      Protocol: HTTP
      Port: 80
      VpcId: !Ref VPC
      TargetType: instance
      HealthCheckPath: /admin/login/
      Targets:
        - Id: !Ref EC2Instance
          Port: 80
      Tags:
        - Key: Name
          Value: education-reserve-tg

  ALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ALB
      Protocol: HTTP
      Port: 80
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup

# ============================================
# Outputs
# ============================================
Outputs:
  ALBURL:
    Description: ALB DNS Name (Access URL)
    Value: !Sub "http://${ALB.DNSName}"

  AdminURL:
    Description: Django Admin URL
    Value: !Sub "http://${ALB.DNSName}/admin/"

  SwaggerURL:
    Description: Swagger UI URL
    Value: !Sub "http://${ALB.DNSName}/api/docs/"

  EC2PublicIP:
    Description: EC2 Public IP (for SSH)
    Value: !GetAtt EC2Instance.PublicIp

  RDSEndpoint:
    Description: RDS Endpoint
    Value: !GetAtt RDSInstance.Endpoint.Address